/**
 * E3 Timestamp Experiment Campaign Loader
 */

/*jslint white:true, vars:true */
/*globals mw, $, murmurhash2_32_gc */

(function ( global ) {
	"use strict";

	var event_id = 'timestamp-history-view';

	// Simple random sampling using murmurhash2
	function inSample( str, fraction ) {
		// murmurhash2_32_gc generates hashes in the 32-bit unsigned
		// integer range ( 0 - 2^32 ).
		var sample = fraction * 4294967296,  // 2^32
			hash = murmurhash2_32_gc( str );
		return ( hash <= sample );
	}

	// Determine whether the current view should display the experiment
	function isEligible() {
		return (

			// The current user has not opted out
			!( mw.user.options.get('vector-noexperiments') === "1" )

			// We're on an article page
			&& mw.config.get( 'wgIsArticle' )

			// The article is in the main namespace
			&& mw.config.get( 'wgNamespaceNumber' ) === 0

			// The article is being viewed (not edited, printed, watched, etc.)
			&& mw.config.get( 'wgAction' ).match( /view|purge/ )

			// This isn't a redirect
			&& mw.util.getParamValue( 'redirect' ) !== 'no'

			// We're not in print view
			&& mw.util.getParamValue( 'printable' ) !== 'yes'

			// We're not viewing a diff
			&& mw.util.getParamValue( 'diff' ) === null
			&& mw.util.getParamValue( 'oldid' ) === null

			// The article is in the experiment sample
			&& inSample( mw.config.get('wgArticleId') + '', 0.006 )
		);
	}

	// The space where we plop the timestamp is subject to contention by
	// various other widgets, extensions and templates, so we need to
	// inspect the dom and make adjustments to CSS according to what we
	// discover.
	function getStyleOverrides() {
		var overrides = {}, icon, offset;

		// Identifiy the leftmost top icon, if present, by passing
		// a custom comparison function to Array.sort.
		icon = Array.prototype.sort.call( $( '.topicon' ), function ( a, b ) {
			return $(a).position().left - $(b).position.left;
		} ).last();

		// If there are any top icons, we'l shift the timestamp to the
		// right of the leftmost one.
		if ( icon.length ) {
			offset = icon.parent().width() - icon.position().left;
			// As a sanity check, make sure we aren't offsetting by
			// more space than we have available.
			if ( offset < $('#bodyContent').width() ) {
				overrides['margin-right'] = offset;
				overrides['padding-right'] = 20;
			}
		}
		return overrides;
	}

	function trackTimestamp() {
		$( function () {
			var el = $( '#mwe-lastmodified' );
			var a = $( 'a', el );

			// Get the base history URI.
			// We prefer the one from the History tab since it is consistant,
			// but older MediaWiki skins don't use the 'ca-history' id.
			if ( $( '#ca-history a' ).length ) {
				var uri = $( '#ca-history a' ).attr( 'href' );
			} else {
				var uri = a.attr( 'href' );
			}

			// The tracking URL is generated by the click-tracking extension. It
			// will log the event and redirect the user to the history page.
			var newUrl = $.trackActionURL( encodeURI( uri ), event_id );

			// Inject the click-tracking redirect URL
			a.attr( 'href', newUrl );

			// Show the last modified message
			el.css( getStyleOverrides() ).show();

			$.trackAction( 'timestamp-impression' );
		} );
	}

	// Register the experiment as a campaign with the clicktracking extension
	mw.activeCampaigns = mw.activeCampaigns || {};
	mw.activeCampaigns.TimestampPosition = {
		name	: 'TimestampPosition',
		version : 1,
		rates   : {
			// Bucket 50% of users into group
			experimental : 1,
			none         : 1
		},
		experimental : function () {
			if ( isEligible() ) {
				mw.loader.using( 'last.modified', trackTimestamp );
			}
		}
	};

}( this ));
